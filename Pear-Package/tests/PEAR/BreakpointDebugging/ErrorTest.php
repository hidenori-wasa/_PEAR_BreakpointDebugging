<?php

chdir(__DIR__ . '/../../../');
require_once './BreakpointDebugging_Including.php';

use \BreakpointDebugging as B;

B::isUnitTestExeMode(true);
/**
 * Test class for BreakpointDebugging_Error.
 * Generated by PHPUnit on 2013-02-17 at 07:57:23.
 */
class BreakpointDebugging_ErrorTest extends \BreakpointDebugging_UnitTestOverriding
{
    static $exeMode;

    static function setUpBeforeClass()
    {
        self::$exeMode = &B::refStatic('$exeMode');
    }

    function setUp()
    {
        parent::setUp();
        $errorLogDirectory = B::getStatic('$_workDir') . '/ErrorLog/';
        if (is_dir($errorLogDirectory)) {
            $errorLogDirElements = scandir($errorLogDirectory);
            foreach ($errorLogDirElements as $errorLogDirElement) {
                $errorLogDirElementPath = $errorLogDirectory . $errorLogDirElement;
                if (!is_file($errorLogDirElementPath)) {
                    continue;
                }
                // Deletes the error log file, variable configuring file or the error location file.
                unlink($errorLogDirElementPath);
            }
            rmdir($errorLogDirectory);
        }
    }

    function tearDown()
    {
        self::$exeMode &= ~B::IGNORING_BREAK_POINT;
        if (ob_get_level() === 2) {
            ob_end_clean();
        }
        B::assert(ob_get_level() === 1);
    }

    /**
     * @covers \BreakpointDebugging_Error<extended>
     */
    function test__construct()
    {
        self::$exeMode = B::LOCAL_DEBUG_OF_RELEASE | B::UNIT_TEST;
        new \BreakpointDebugging_Error();

        self::$exeMode = B::LOCAL_DEBUG | B::UNIT_TEST;
        new \BreakpointDebugging_Error();

        B::setXebugExists(false);
        new \BreakpointDebugging_Error();
        B::setXebugExists(true);
    }

    function exceptionHandler2()
    {
        throw new \Exception();
    }

    /**
     * @covers \BreakpointDebugging_Error<extended>
     */
    public function testExceptionHandler2()
    {
        ob_start();

        $maxLogStringSize = &B::refStatic('$_maxLogStringSize');
        $maxLogStringSize = 140000;

        $exceptionWithGLOBALS = function ($self) {
                try {
                    B::addValuesToTrace(array (array ('TestString')));
                    $self->exceptionHandler2($GLOBALS, array ('Test1.'));
                } catch (\Exception $e) {
                    B::handleException($e);
                }
            };

        $logfileMaximumCapacityException = function ($self) {
                try {
                    $self->exceptionHandler2(str_repeat('1234567890', 14000), array ('Test1.'), 1.1);
                } catch (\Exception $e) {
                    B::handleException($e);
                }
            };

        self::$exeMode = B::LOCAL_DEBUG | B::UNIT_TEST | B::IGNORING_BREAK_POINT;
        $exceptionWithGLOBALS($this);
        $logfileMaximumCapacityException($this);

        self::$exeMode = B::LOCAL_DEBUG_OF_RELEASE | B::UNIT_TEST | B::IGNORING_BREAK_POINT;
        $exceptionWithGLOBALS($this);
        $logfileMaximumCapacityException($this);

        self::$exeMode = B::REMOTE_DEBUG | B::UNIT_TEST | B::IGNORING_BREAK_POINT;
        $exceptionWithGLOBALS($this);
        $logfileMaximumCapacityException($this);

        ob_end_clean();
    }

    /**
     * @covers \BreakpointDebugging_Error<extended>
     *
     * @expectedException \BreakpointDebugging_ErrorException
     * @expectedExceptionMessage CLASS=BreakpointDebugging_Error FUNCTION=logBufferWriting ID=4
     *
     */
    public function testExceptionHandler2_B()
    {
        self::$exeMode = B::LOCAL_DEBUG | B::UNIT_TEST | B::IGNORING_BREAK_POINT | 256;
        B::handleException(new \Exception());
    }

    /**
     * @covers \BreakpointDebugging_Error<extended>
     */
    public function testErrorHandler2()
    {
        ob_start();

        self::$exeMode = B::LOCAL_DEBUG | B::UNIT_TEST | B::IGNORING_BREAK_POINT;
        B::handleError(E_USER_ERROR, '');

        ob_end_clean();
    }

}

?>
